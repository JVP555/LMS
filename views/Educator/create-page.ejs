<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= title %></title>
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <style>
    /* Scroll-to-top button for editor */
    #editorScrollTopBtn {
      display: block;
      position: absolute;
      top: 32px;
      right: 6px;
      color: black;
      padding: 0.3rem 0.4rem;
      font-weight: 600;
      font-size: 1.5rem;
      cursor: pointer;
    }

    body {
      overflow-y: hidden;
      padding-bottom: 0;
    }

    .ck-editor__editable_inline {
      height: 30vh;
      overflow-y: auto;
      position: relative;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans mb-2">

  <%- include('../General/header') %>
  <%- include('../General/notifications', { messages: messages }) %>

  <% let formAction = ''; %>
  <% if (title === 'Create New Page') { %>
    <% formAction = '/my-chapter/' + chapterId + '/my-pages'; %>
  <% } else if (title === 'Edit Page') { %>
    <% formAction = '/pages/' + page.id + '/edit'; %>
  <% } %>

  <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center"><%= title %></h1>
    <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">
      <%= title === 'Edit Page' ? 'Update Page Details' : 'Create a New Page' %>
    </h2>

    <form id="mainForm" method="POST" action="<%= formAction %>">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <div class="mb-4">
        <label for="title" class="block text-lg font-medium text-gray-700 mb-2">Page Title:</label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value="<%= page.title || '' %>" 
          required 
          class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500"
        >
      </div>

      <div class="mb-4 relative">
        <label for="editor" class="block text-lg font-medium text-gray-700 mb-2">Content:</label>
        <textarea 
          id="editor" 
          name="content" 
          rows="10"
        ><%- page.content || '' %></textarea>
        <div id="charCount" class="text-sm text-gray-500 mt-1">0 / 100000 characters</div>

        <!-- Scroll to Top Button for CKEditor -->
        <button id="editorScrollTopBtn" type="button" class="text-l" onclick="scrollEditorToTop()">â¬†</button>
      </div>

      <div class="mt-3">
        <button 
          type="submit"
          form="mainForm"
          onclick="document.querySelector('form').reportValidity()"
          class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:ring-2"
        >
          <%= title.includes('Edit') ? 'Update' : 'Create' %> Page
        </button>
      </div>
    </form>
  </div>

  <!-- CKEditor + Character Count + Scroll Button Logic -->
  <script>
    let editorInstance;
    const maxCharacters = 100000;
    const charCount = document.getElementById('charCount');
    const scrollBtn = document.getElementById('editorScrollTopBtn');

    function scrollEditorToTop() {
      const editableArea = document.querySelector('.ck-editor__editable_inline');
      editableArea.scrollTo({ top: 0, behavior: 'smooth' });
    }

    ClassicEditor
      .create(document.querySelector('#editor'))
      .then(editor => {
        editorInstance = editor;

        // Character count update
        const updateCount = () => {
          const len = editor.getData().replace(/<[^>]*>/g, '').length;
          charCount.textContent = `${len} / ${maxCharacters} characters`;
          charCount.classList.toggle("text-red-500", len > maxCharacters);
        };
        editor.model.document.on('change:data', updateCount);
        updateCount();
      })
      .catch(error => {
        console.error(error);
      });
  </script>
  
</body>
</html>
